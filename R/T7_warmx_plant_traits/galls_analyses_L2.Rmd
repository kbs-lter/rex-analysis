---
title: "REX: Gall Analyses"
author: "Moriah Young"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: pdf_document
---

COLLABORATORS: Phoebe Zarnetske, Mark Hammond, Kara Dobson, Emily Parker, Kristin Wolford 
DATA INPUT: Clean & plot gall csv from the shared Google drive  
DATA OUTPUT: Code and Rmd are in the scripts folder in Github  
PROJECT: REX  

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
# Clear all existing data
rm(list=ls())

# Load packages
library(bbmle)
library(lmerTest)
library(fitdistrplus)
library(sjPlot)
library(car)
library(emmeans)
library(tidyverse)
library(ggpubr)
library(jtools) #summ 

# Set working directory from .Renviron
dir <- Sys.getenv("ANALYSIS_DIR")
list.files(dir)

# Read in data
galls <- read.csv(file.path(dir, "T7_warmx_plant_traits/L1/T7_warmx_galls_L1.csv"))

# making it so that plant_height, gall_diameter, and gall_height are on the same row for the same plant
# so each unique plant will have just one row ompared to two in the raw data.
#galls2 <- galls %>% 
#        select(-date) %>% 
#        group_by(rep, footprint, treatment, plant_num, gall_present) %>% 
#        summarise(across(everything(), na.omit)) %>% 
#        distinct()

galls3<- galls %>% select(rep, footprint, treatment, plant_num, gall_present, plant_height) %>% 
  na.omit() #this is just plant height data

galls4 <- galls %>% select(-plant_height) %>% 
  na.omit() %>% 
  full_join(galls3)

galls5 <- galls4 %>% select(-date) # get rid of date - we don't need this and some have NAs

# create a dateframe that only contains galled plants
gall_only <- galls5[!(galls5$gall_present == "no_gall"),]
gall_only <- gall_only[-131, ]

# Take subplot average of plant height
plant_height <- galls5 %>%
        group_by(rep, footprint, treatment, gall_present) %>%
        summarize(plant_height = mean(plant_height, na.rm = TRUE))

# Take subplot average of plant height
gall_height <- galls5 %>%
        group_by(rep, footprint, treatment, gall_present) %>%
        summarize(gall_height = mean(gall_height, na.rm = TRUE))

# Take subplot average of plant height
gall_diameter <- galls5 %>%
        group_by(rep, footprint, treatment, gall_present) %>%
        summarize(gall_diameter = mean(gall_diameter, na.rm = TRUE))

mean_galls <- left_join(plant_height, gall_height)
mean_galls <- left_join(mean_galls, gall_diameter)
        
# Emily only wants to look at the effects of warming on goldenrod & galls so get rid of "drought" and "warmed_drought"
# gall_warmed <- galls2[!(galls2$treatment == "drought" | galls2$treatment == "warmed_drought"),]
```

Emily's questions:
1. Is there a relationship between plant height & likeliness of galling (i.e. are taller plants more likely to get a gall, or have multiple galls)?
2. Are plant height & area of gall related?

```{r}
# MEAN OF VARIABLES DATA
# Data exploration
descdist(mean_galls$plant_height, discrete = FALSE)
hist(mean_galls$plant_height)
qqnorm(mean_galls$plant_height)
shapiro.test(mean_galls$plant_height) # not normally distributed

# taking the lognormal of plant height
mean_galls$lph <- log(mean_galls$plant_height)
descdist(mean_galls$lph, discrete = FALSE)
hist(mean_galls$lph)
qqnorm(mean_galls$lph)
shapiro.test(mean_galls$lph) # normally distributed!

b0 <- lm(lph ~ 1, data = mean_galls)
b1 <- lm(lph ~ treatment, data = mean_galls)
b2 <- lm(lph ~ treatment + gall_present, data = mean_galls)
b3 <- lm(lph ~ treatment * gall_present, data = mean_galls)
b4 <- lmer(lph ~ treatment + gall_present + (1|rep), data = mean_galls)
b5 <- lmer(lph ~ treatment * gall_present + (1|rep), data = mean_galls)

AICctab(b0,b1,b2,b3,b4,b5, weights=T)
summ(b1)
summ(b2)
```

Looking at plant height first
```{r}
# Data exploration
descdist(galls3$plant_height, discrete = FALSE)
hist(galls3$plant_height)
qqnorm(galls3$plant_height)
shapiro.test(galls3$plant_height) # not normally distributed

# Let's look at gall vs no gall distributions
no_gall_height <- galls3[(galls3$gall_present == "no_gall"),]
just_gall_height <- galls3[(galls3$gall_present == "gall"),]

# Data exploration for gall plants
descdist(just_gall_height$plant_height, discrete = FALSE)
hist(galls3$plant_height)
qqnorm(just_gall_height$plant_height)
shapiro.test(just_gall_height$plant_height) # not normally distributed

# Data exploration for non gall plants
descdist(no_gall_height$plant_height, discrete = FALSE)
hist(no_gall_height$plant_height)
qqnorm(no_gall_height$plant_height)
shapiro.test(no_gall_height$plant_height) # normally distributed

# let's take the lognormal of plant height
galls3$lph <- log(galls3$plant_height)
descdist(galls3$lph, discrete = FALSE)
hist(galls3$lph)
qqnorm(galls3$lph)
shapiro.test(galls3$lph) # normally distributed!
```

```{r}
# Assumption checking
m1 <- lmer(plant_height~ treatment + gall_present + (1|rep), data = galls3, REML=FALSE)
# Check Assumptions:
# (1) Linearity: if covariates are not categorical
# (2) Homogeneity: Need to Check by plotting residuals vs predicted values.
plot(m1, main = "Plant Height")
# Homogeneity of variance is ok here (increasing variance in resids is not increasing with fitted values)
# Check for homogeneity of variances (true if p>0.05). If the result is not significant, the assumption of equal variances (homoscedasticity) is met (no significant difference between the group variances).
leveneTest(residuals(m1) ~ galls3$treatment)
# Assumption not met
leveneTest(residuals(m1) ~ galls3$gall_present)
# Assumption not met
# (3) Normality of error term: need to check by histogram, QQplot of residuals, could do Kolmogorov-Smirnov test.
# Check for normal residuals
qqPlot(resid(m1), main = "Plant Height")
hist(residuals(m1), main = "Plant Height")
shapiro.test(resid(m1)) # Normal

# checking assumptions with log of plant heights
m1l <- lmer(lph~ treatment + gall_present + (1|rep), data = galls3, REML=FALSE)
# Check Assumptions:
# (1) Linearity: if covariates are not categorical
# (2) Homogeneity: Need to Check by plotting residuals vs predicted values.
plot(m1l, main = "Plant Height")
# Homogeneity of variance is ok here (increasing variance in resids is not increasing with fitted values)
# Check for homogeneity of variances (true if p>0.05). If the result is not significant, the assumption of equal variances (homoscedasticity) is met (no significant difference between the group variances).
leveneTest(residuals(m1l) ~ galls3$treatment)
# Assumption met
leveneTest(residuals(m1l) ~ galls3$gall_present)
# Assumption not met
# (3) Normality of error term: need to check by histogram, QQplot of residuals, could do Kolmogorov-Smirnov test.
# Check for normal residuals
qqPlot(resid(m1l), main = "Plant Height")
hist(residuals(m1l), main = "Plant Height")
shapiro.test(resid(m1l)) # Normal

# Model comparisons
m2 <- lm(plant_height ~ treatment, data=galls3)
m3 <- lm(plant_height ~ gall_present, data=galls3)
m4 <- lmer(plant_height ~ treatment + (1|rep), data=galls3, REML=F)
m5 <- lmer(plant_height ~ treatment * gall_present + (1|rep), data=galls3, REML=F)
AICctab(m1, m2, m3, m4, m5, weights=T)
# Models 5 and 1 fits the best
summ(m5)
summ(m1)

# Model comparisons with log plant height
m2l <- lm(plant_height ~ treatment, data=galls3)
m3l <- lm(plant_height ~ gall_present, data=galls3)
m4l <- lmer(plant_height ~ treatment + (1|rep), data=galls3, REML=F)
m5l <- lmer(plant_height ~ treatment * gall_present + (1|rep), data=galls3, REML=F)
AICctab(m1l, m2l, m3l, m4l, m5l, weights=T)
# Model 1 fits the best
summ(m1l)
```


```{r}
# taking the lognormal of plant height in the gall only dataframe
gall_only$lph <- log(gall_only$plant_height)
descdist(gall_only$lph, discrete = FALSE)
hist(gall_only$lph)
qqnorm(gall_only$lph)
shapiro.test(gall_only$lph) # normally distributed!

# Looking at plant height as a response variable and treatment as an explanatory variable. 
w0 <- lm(lph ~ 1, data=gall_only)
w1 <- lm(lph ~ treatment, data=gall_only)
w2 <- lm(lph ~ gall_diameter, data=gall_only)
w3 <- lm(lph ~ gall_height, data=gall_only)
w4 <- lm(lph ~ treatment + (1|rep), data=gall_only)
w5 <- lm(lph ~ treatment + gall_diameter, data=gall_only)
w6 <- lm(lph ~ treatment + gall_height, data=gall_only)
w7 <- lm(lph ~ treatment * gall_diameter, data=gall_only)
w8 <- lm(lph ~ treatment * gall_height, data=gall_only)
w9 <- lm(lph ~ treatment + gall_diameter + (1|rep), data=gall_only)
w10 <- lm(lph ~ treatment + gall_height + (1|rep), data=gall_only)
w11 <- lm(lph ~ treatment * gall_diameter + (1|rep), data=gall_only)
w12 <- lm(lph ~ treatment * gall_height + (1|rep), data=gall_only)

AICctab(w0,w1,w2,w3,w4,w5,w6,w7,w8,w9,w10,w11,w12, weights=TRUE)
```


Simple t-test of plant height between galled and non galled plants
```{r}
group_by(galls3, gall_present) %>%
        summarise(count = n(),
            mean = mean(plant_height, na.rm = TRUE),
            sd = sd(plant_height), na.rm = TRUE)

ggboxplot(galls3, x = "gall_present", y = "plant_height", 
          color = "gall_present", palette = c("#00AFBB", "#E7B800"),
        ylab = "Plant Height", xlab = "Gall Present")

# Shapiro-Wilk normality test for gall plant height
with(galls3, shapiro.test(plant_height[gall_present == "gall"])) # p = 0.002157 - not normally distributed
# Shapiro-Wilk normality test for non galled plant height
with(galls3, shapiro.test(plant_height[gall_present == "no_gall"])) # 0.08565 - normally distributed

# Because gall plant height does not pass the Shapiro-Wilk normality test, doing a non parametric two-samples
# Wilcoxon rank test
res <- wilcox.test(plant_height ~ gall_present, data = galls3,
                   exact = FALSE)
res # p-value = 0.1872

# p-value = 0.1872, which is greater than the significance level alpha = 0.05, therefore we can conclude that gall and no gall plant height is not significantly different from one another.
```

